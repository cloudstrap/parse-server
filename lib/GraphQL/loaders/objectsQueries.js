"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.load = exports.findObjects = exports.getObject = void 0;

var _graphql = require("graphql");

var _graphqlListFields = _interopRequireDefault(require("graphql-list-fields"));

var _node = _interopRequireDefault(require("parse/node"));

var defaultGraphQLTypes = _interopRequireWildcard(require("./defaultGraphQLTypes"));

var _rest = _interopRequireDefault(require("../../rest"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const getObject = async (className, objectId, keys, include, readPreference, includeReadPreference, config, auth, info) => {
  const options = {};

  if (keys) {
    options.keys = keys;
  }

  if (include) {
    options.include = include;

    if (includeReadPreference) {
      options.includeReadPreference = includeReadPreference;
    }
  }

  if (readPreference) {
    options.readPreference = readPreference;
  }

  const response = await _rest.default.get(config, auth, className, objectId, options, info.clientSDK);

  if (!response.results || response.results.length == 0) {
    throw new _node.default.Error(_node.default.Error.OBJECT_NOT_FOUND, 'Object not found.');
  }

  if (className === '_User') {
    delete response.results[0].sessionToken;
  }

  return response.results[0];
};

exports.getObject = getObject;
const parseMap = {
  _or: '$or',
  _and: '$and',
  _nor: '$nor',
  _relatedTo: '$relatedTo',
  _eq: '$eq',
  _ne: '$ne',
  _lt: '$lt',
  _lte: '$lte',
  _gt: '$gt',
  _gte: '$gte',
  _in: '$in',
  _nin: '$nin',
  _exists: '$exists',
  _select: '$select',
  _dontSelect: '$dontSelect',
  _inQuery: '$inQuery',
  _notInQuery: '$notInQuery',
  _containedBy: '$containedBy',
  _all: '$all',
  _regex: '$regex',
  _options: '$options',
  _text: '$text',
  _search: '$search',
  _term: '$term',
  _language: '$language',
  _caseSensitive: '$caseSensitive',
  _diacriticSensitive: '$diacriticSensitive',
  _nearSphere: '$nearSphere',
  _maxDistance: '$maxDistance',
  _maxDistanceInRadians: '$maxDistanceInRadians',
  _maxDistanceInMiles: '$maxDistanceInMiles',
  _maxDistanceInKilometers: '$maxDistanceInKilometers',
  _within: '$within',
  _box: '$box',
  _geoWithin: '$geoWithin',
  _polygon: '$polygon',
  _centerSphere: '$centerSphere',
  _geoIntersects: '$geoIntersects',
  _point: '$point'
};

const transformToParse = constraints => {
  if (!constraints || typeof constraints !== 'object') {
    return;
  }

  Object.keys(constraints).forEach(fieldName => {
    let fieldValue = constraints[fieldName];

    if (parseMap[fieldName]) {
      delete constraints[fieldName];
      fieldName = parseMap[fieldName];
      constraints[fieldName] = fieldValue;
    }

    switch (fieldName) {
      case '$point':
      case '$nearSphere':
        if (typeof fieldValue === 'object' && !fieldValue.__type) {
          fieldValue.__type = 'GeoPoint';
        }

        break;

      case '$box':
        if (typeof fieldValue === 'object' && fieldValue.bottomLeft && fieldValue.upperRight) {
          fieldValue = [_objectSpread({
            __type: 'GeoPoint'
          }, fieldValue.bottomLeft), _objectSpread({
            __type: 'GeoPoint'
          }, fieldValue.upperRight)];
          constraints[fieldName] = fieldValue;
        }

        break;

      case '$polygon':
        if (fieldValue instanceof Array) {
          fieldValue.forEach(geoPoint => {
            if (typeof geoPoint === 'object' && !geoPoint.__type) {
              geoPoint.__type = 'GeoPoint';
            }
          });
        }

        break;

      case '$centerSphere':
        if (typeof fieldValue === 'object' && fieldValue.center && fieldValue.distance) {
          fieldValue = [_objectSpread({
            __type: 'GeoPoint'
          }, fieldValue.center), fieldValue.distance];
          constraints[fieldName] = fieldValue;
        }

        break;
    }

    if (typeof fieldValue === 'object') {
      transformToParse(fieldValue);
    }
  });
};

const findObjects = async (className, where, order, skip, limit, keys, include, includeAll, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields) => {
  if (!where) {
    where = {};
  }

  transformToParse(where);
  const options = {};

  if (selectedFields.includes('results')) {
    if (limit || limit === 0) {
      options.limit = limit;
    }

    if (options.limit !== 0) {
      if (order) {
        options.order = order;
      }

      if (skip) {
        options.skip = skip;
      }

      if (config.maxLimit && options.limit > config.maxLimit) {
        // Silently replace the limit on the query with the max configured
        options.limit = config.maxLimit;
      }

      if (keys) {
        options.keys = keys;
      }

      if (includeAll === true) {
        options.includeAll = includeAll;
      }

      if (!options.includeAll && include) {
        options.include = include;
      }

      if ((options.includeAll || options.include) && includeReadPreference) {
        options.includeReadPreference = includeReadPreference;
      }
    }
  } else {
    options.limit = 0;
  }

  if (selectedFields.includes('count')) {
    options.count = true;
  }

  if (readPreference) {
    options.readPreference = readPreference;
  }

  if (Object.keys(where).length > 0 && subqueryReadPreference) {
    options.subqueryReadPreference = subqueryReadPreference;
  }

  return await _rest.default.find(config, auth, className, where, options, info.clientSDK);
};

exports.findObjects = findObjects;

const load = parseGraphQLSchema => {
  parseGraphQLSchema.graphQLObjectsQueries.get = {
    description: 'The get query can be used to get an object of a certain class by its objectId.',
    args: {
      className: defaultGraphQLTypes.CLASS_NAME_ATT,
      objectId: defaultGraphQLTypes.OBJECT_ID_ATT,
      keys: defaultGraphQLTypes.KEYS_ATT,
      include: defaultGraphQLTypes.INCLUDE_ATT,
      readPreference: defaultGraphQLTypes.READ_PREFERENCE_ATT,
      includeReadPreference: defaultGraphQLTypes.INCLUDE_READ_PREFERENCE_ATT
    },
    type: new _graphql.GraphQLNonNull(defaultGraphQLTypes.OBJECT),

    async resolve(_source, args, context) {
      try {
        const {
          className,
          objectId,
          keys,
          include,
          readPreference,
          includeReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        return await getObject(className, objectId, keys, include, readPreference, includeReadPreference, config, auth, info);
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  };
  parseGraphQLSchema.graphQLObjectsQueries.find = {
    description: 'The find query can be used to find objects of a certain class.',
    args: {
      className: defaultGraphQLTypes.CLASS_NAME_ATT,
      where: defaultGraphQLTypes.WHERE_ATT,
      order: {
        description: 'This is the order in which the objects should be returned',
        type: _graphql.GraphQLString
      },
      skip: defaultGraphQLTypes.SKIP_ATT,
      limit: defaultGraphQLTypes.LIMIT_ATT,
      keys: defaultGraphQLTypes.KEYS_ATT,
      include: defaultGraphQLTypes.INCLUDE_ATT,
      includeAll: {
        description: 'All pointers will be returned',
        type: _graphql.GraphQLBoolean
      },
      readPreference: defaultGraphQLTypes.READ_PREFERENCE_ATT,
      includeReadPreference: defaultGraphQLTypes.INCLUDE_READ_PREFERENCE_ATT,
      subqueryReadPreference: defaultGraphQLTypes.SUBQUERY_READ_PREFERENCE_ATT
    },
    type: new _graphql.GraphQLNonNull(defaultGraphQLTypes.FIND_RESULT),

    async resolve(_source, args, context, queryInfo) {
      try {
        const {
          className,
          where,
          order,
          skip,
          limit,
          keys,
          include,
          includeAll,
          readPreference,
          includeReadPreference,
          subqueryReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        const selectedFields = (0, _graphqlListFields.default)(queryInfo);
        return await findObjects(className, where, order, skip, limit, keys, include, includeAll, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields);
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  };
  const objectsQuery = new _graphql.GraphQLObjectType({
    name: 'ObjectsQuery',
    description: 'ObjectsQuery is the top level type for objects queries.',
    fields: parseGraphQLSchema.graphQLObjectsQueries
  });
  parseGraphQLSchema.graphQLTypes.push(objectsQuery);
  parseGraphQLSchema.graphQLQueries.objects = {
    description: 'This is the top level for objects queries.',
    type: objectsQuery,
    resolve: () => new Object()
  };
};

exports.load = load;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HcmFwaFFML2xvYWRlcnMvb2JqZWN0c1F1ZXJpZXMuanMiXSwibmFtZXMiOlsiZ2V0T2JqZWN0IiwiY2xhc3NOYW1lIiwib2JqZWN0SWQiLCJrZXlzIiwiaW5jbHVkZSIsInJlYWRQcmVmZXJlbmNlIiwiaW5jbHVkZVJlYWRQcmVmZXJlbmNlIiwiY29uZmlnIiwiYXV0aCIsImluZm8iLCJvcHRpb25zIiwicmVzcG9uc2UiLCJyZXN0IiwiZ2V0IiwiY2xpZW50U0RLIiwicmVzdWx0cyIsImxlbmd0aCIsIlBhcnNlIiwiRXJyb3IiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwic2Vzc2lvblRva2VuIiwicGFyc2VNYXAiLCJfb3IiLCJfYW5kIiwiX25vciIsIl9yZWxhdGVkVG8iLCJfZXEiLCJfbmUiLCJfbHQiLCJfbHRlIiwiX2d0IiwiX2d0ZSIsIl9pbiIsIl9uaW4iLCJfZXhpc3RzIiwiX3NlbGVjdCIsIl9kb250U2VsZWN0IiwiX2luUXVlcnkiLCJfbm90SW5RdWVyeSIsIl9jb250YWluZWRCeSIsIl9hbGwiLCJfcmVnZXgiLCJfb3B0aW9ucyIsIl90ZXh0IiwiX3NlYXJjaCIsIl90ZXJtIiwiX2xhbmd1YWdlIiwiX2Nhc2VTZW5zaXRpdmUiLCJfZGlhY3JpdGljU2Vuc2l0aXZlIiwiX25lYXJTcGhlcmUiLCJfbWF4RGlzdGFuY2UiLCJfbWF4RGlzdGFuY2VJblJhZGlhbnMiLCJfbWF4RGlzdGFuY2VJbk1pbGVzIiwiX21heERpc3RhbmNlSW5LaWxvbWV0ZXJzIiwiX3dpdGhpbiIsIl9ib3giLCJfZ2VvV2l0aGluIiwiX3BvbHlnb24iLCJfY2VudGVyU3BoZXJlIiwiX2dlb0ludGVyc2VjdHMiLCJfcG9pbnQiLCJ0cmFuc2Zvcm1Ub1BhcnNlIiwiY29uc3RyYWludHMiLCJPYmplY3QiLCJmb3JFYWNoIiwiZmllbGROYW1lIiwiZmllbGRWYWx1ZSIsIl9fdHlwZSIsImJvdHRvbUxlZnQiLCJ1cHBlclJpZ2h0IiwiQXJyYXkiLCJnZW9Qb2ludCIsImNlbnRlciIsImRpc3RhbmNlIiwiZmluZE9iamVjdHMiLCJ3aGVyZSIsIm9yZGVyIiwic2tpcCIsImxpbWl0IiwiaW5jbHVkZUFsbCIsInN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UiLCJzZWxlY3RlZEZpZWxkcyIsImluY2x1ZGVzIiwibWF4TGltaXQiLCJjb3VudCIsImZpbmQiLCJsb2FkIiwicGFyc2VHcmFwaFFMU2NoZW1hIiwiZ3JhcGhRTE9iamVjdHNRdWVyaWVzIiwiZGVzY3JpcHRpb24iLCJhcmdzIiwiZGVmYXVsdEdyYXBoUUxUeXBlcyIsIkNMQVNTX05BTUVfQVRUIiwiT0JKRUNUX0lEX0FUVCIsIktFWVNfQVRUIiwiSU5DTFVERV9BVFQiLCJSRUFEX1BSRUZFUkVOQ0VfQVRUIiwiSU5DTFVERV9SRUFEX1BSRUZFUkVOQ0VfQVRUIiwidHlwZSIsIkdyYXBoUUxOb25OdWxsIiwiT0JKRUNUIiwicmVzb2x2ZSIsIl9zb3VyY2UiLCJjb250ZXh0IiwiZSIsImhhbmRsZUVycm9yIiwiV0hFUkVfQVRUIiwiR3JhcGhRTFN0cmluZyIsIlNLSVBfQVRUIiwiTElNSVRfQVRUIiwiR3JhcGhRTEJvb2xlYW4iLCJTVUJRVUVSWV9SRUFEX1BSRUZFUkVOQ0VfQVRUIiwiRklORF9SRVNVTFQiLCJxdWVyeUluZm8iLCJvYmplY3RzUXVlcnkiLCJHcmFwaFFMT2JqZWN0VHlwZSIsIm5hbWUiLCJmaWVsZHMiLCJncmFwaFFMVHlwZXMiLCJwdXNoIiwiZ3JhcGhRTFF1ZXJpZXMiLCJvYmplY3RzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBTUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFFQSxNQUFNQSxTQUFTLEdBQUcsT0FDaEJDLFNBRGdCLEVBRWhCQyxRQUZnQixFQUdoQkMsSUFIZ0IsRUFJaEJDLE9BSmdCLEVBS2hCQyxjQUxnQixFQU1oQkMscUJBTmdCLEVBT2hCQyxNQVBnQixFQVFoQkMsSUFSZ0IsRUFTaEJDLElBVGdCLEtBVWI7QUFDSCxRQUFNQyxPQUFPLEdBQUcsRUFBaEI7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LGNBQWMsR0FBRyxnQ0FBY2dDLFNBQWQsQ0FBdkI7QUFFQSxlQUFPLE1BQU12QyxXQUFXLENBQ3RCekUsU0FEc0IsRUFFdEIwRSxLQUZzQixFQUd0QkMsS0FIc0IsRUFJdEJDLElBSnNCLEVBS3RCQyxLQUxzQixFQU10QjNFLElBTnNCLEVBT3RCQyxPQVBzQixFQVF0QjJFLFVBUnNCLEVBU3RCMUUsY0FUc0IsRUFVdEJDLHFCQVZzQixFQVd0QjBFLHNCQVhzQixFQVl0QnpFLE1BWnNCLEVBYXRCQyxJQWJzQixFQWN0QkMsSUFkc0IsRUFldEJ3RSxjQWZzQixDQUF4QjtBQWlCRCxPQWxDRCxDQWtDRSxPQUFPdUIsQ0FBUCxFQUFVO0FBQ1ZqQixRQUFBQSxrQkFBa0IsQ0FBQ2tCLFdBQW5CLENBQStCRCxDQUEvQjtBQUNEO0FBQ0Y7O0FBOUQ2QyxHQUFoRDtBQWlFQSxRQUFNVSxZQUFZLEdBQUcsSUFBSUMsMEJBQUosQ0FBc0I7QUFDekNDLElBQUFBLElBQUksRUFBRSxjQURtQztBQUV6QzNCLElBQUFBLFdBQVcsRUFBRSx5REFGNEI7QUFHekM0QixJQUFBQSxNQUFNLEVBQUU5QixrQkFBa0IsQ0FBQ0M7QUFIYyxHQUF0QixDQUFyQjtBQUtBRCxFQUFBQSxrQkFBa0IsQ0FBQytCLFlBQW5CLENBQWdDQyxJQUFoQyxDQUFxQ0wsWUFBckM7QUFFQTNCLEVBQUFBLGtCQUFrQixDQUFDaUMsY0FBbkIsQ0FBa0NDLE9BQWxDLEdBQTRDO0FBQzFDaEMsSUFBQUEsV0FBVyxFQUFFLDRDQUQ2QjtBQUUxQ1MsSUFBQUEsSUFBSSxFQUFFZ0IsWUFGb0M7QUFHMUNiLElBQUFBLE9BQU8sRUFBRSxNQUFNLElBQUl0QyxNQUFKO0FBSDJCLEdBQTVDO0FBS0QsQ0F2SEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBHcmFwaFFMTm9uTnVsbCxcbiAgR3JhcGhRTEJvb2xlYW4sXG4gIEdyYXBoUUxTdHJpbmcsXG4gIEdyYXBoUUxPYmplY3RUeXBlLFxufSBmcm9tICdncmFwaHFsJztcbmltcG9ydCBnZXRGaWVsZE5hbWVzIGZyb20gJ2dyYXBocWwtbGlzdC1maWVsZHMnO1xuaW1wb3J0IFBhcnNlIGZyb20gJ3BhcnNlL25vZGUnO1xuaW1wb3J0ICogYXMgZGVmYXVsdEdyYXBoUUxUeXBlcyBmcm9tICcuL2RlZmF1bHRHcmFwaFFMVHlwZXMnO1xuaW1wb3J0IHJlc3QgZnJvbSAnLi4vLi4vcmVzdCc7XG5cbmNvbnN0IGdldE9iamVjdCA9IGFzeW5jIChcbiAgY2xhc3NOYW1lLFxuICBvYmplY3RJZCxcbiAga2V5cyxcbiAgaW5jbHVkZSxcbiAgcmVhZFByZWZlcmVuY2UsXG4gIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSxcbiAgY29uZmlnLFxuICBhdXRoLFxuICBpbmZvXG4pID0+IHtcbiAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuICBpZiAoa2V5cykge1xuICAgIG9wdGlvbnMua2V5cyA9IGtleXM7XG4gIH1cbiAgaWYgKGluY2x1ZGUpIHtcbiAgICBvcHRpb25zLmluY2x1ZGUgPSBpbmNsdWRlO1xuICAgIGlmIChpbmNsdWRlUmVhZFByZWZlcmVuY2UpIHtcbiAgICAgIG9wdGlvbnMuaW5jbHVkZVJlYWRQcmVmZXJlbmNlID0gaW5jbHVkZVJlYWRQcmVmZXJlbmNlO1xuICAgIH1cbiAgfVxuICBpZiAocmVhZFByZWZlcmVuY2UpIHtcbiAgICBvcHRpb25zLnJlYWRQcmVmZXJlbmNlID0gcmVhZFByZWZlcmVuY2U7XG4gIH1cblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlc3QuZ2V0KFxuICAgIGNvbmZpZyxcbiAgICBhdXRoLFxuICAgIGNsYXNzTmFtZSxcbiAgICBvYmplY3RJZCxcbiAgICBvcHRpb25zLFxuICAgIGluZm8uY2xpZW50U0RLXG4gICk7XG5cbiAgaWYgKCFyZXNwb25zZS5yZXN1bHRzIHx8IHJlc3BvbnNlLnJlc3VsdHMubGVuZ3RoID09IDApIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCwgJ09iamVjdCBub3QgZm91bmQuJyk7XG4gIH1cblxuICBpZiAoY2xhc3NOYW1lID09PSAnX1VzZXInKSB7XG4gICAgZGVsZXRlIHJlc3BvbnNlLnJlc3VsdHNbMF0uc2Vzc2lvblRva2VuO1xuICB9XG5cbiAgcmV0dXJuIHJlc3BvbnNlLnJlc3VsdHNbMF07XG59O1xuXG5jb25zdCBwYXJzZU1hcCA9IHtcbiAgX29yOiAnJG9yJyxcbiAgX2FuZDogJyRhbmQnLFxuICBfbm9yOiAnJG5vcicsXG4gIF9yZWxhdGVkVG86ICckcmVsYXRlZFRvJyxcbiAgX2VxOiAnJGVxJyxcbiAgX25lOiAnJG5lJyxcbiAgX2x0OiAnJGx0JyxcbiAgX2x0ZTogJyRsdGUnLFxuICBfZ3Q6ICckZ3QnLFxuICBfZ3RlOiAnJGd0ZScsXG4gIF9pbjogJyRpbicsXG4gIF9uaW46ICckbmluJyxcbiAgX2V4aXN0czogJyRleGlzdHMnLFxuICBfc2VsZWN0OiAnJHNlbGVjdCcsXG4gIF9kb250U2VsZWN0OiAnJGRvbnRTZWxlY3QnLFxuICBfaW5RdWVyeTogJyRpblF1ZXJ5JyxcbiAgX25vdEluUXVlcnk6ICckbm90SW5RdWVyeScsXG4gIF9jb250YWluZWRCeTogJyRjb250YWluZWRCeScsXG4gIF9hbGw6ICckYWxsJyxcbiAgX3JlZ2V4OiAnJHJlZ2V4JyxcbiAgX29wdGlvbnM6ICckb3B0aW9ucycsXG4gIF90ZXh0OiAnJHRleHQnLFxuICBfc2VhcmNoOiAnJHNlYXJjaCcsXG4gIF90ZXJtOiAnJHRlcm0nLFxuICBfbGFuZ3VhZ2U6ICckbGFuZ3VhZ2UnLFxuICBfY2FzZVNlbnNpdGl2ZTogJyRjYXNlU2Vuc2l0aXZlJyxcbiAgX2RpYWNyaXRpY1NlbnNpdGl2ZTogJyRkaWFjcml0aWNTZW5zaXRpdmUnLFxuICBfbmVhclNwaGVyZTogJyRuZWFyU3BoZXJlJyxcbiAgX21heERpc3RhbmNlOiAnJG1heERpc3RhbmNlJyxcbiAgX21heERpc3RhbmNlSW5SYWRpYW5zOiAnJG1heERpc3RhbmNlSW5SYWRpYW5zJyxcbiAgX21heERpc3RhbmNlSW5NaWxlczogJyRtYXhEaXN0YW5jZUluTWlsZXMnLFxuICBfbWF4RGlzdGFuY2VJbktpbG9tZXRlcnM6ICckbWF4RGlzdGFuY2VJbktpbG9tZXRlcnMnLFxuICBfd2l0aGluOiAnJHdpdGhpbicsXG4gIF9ib3g6ICckYm94JyxcbiAgX2dlb1dpdGhpbjogJyRnZW9XaXRoaW4nLFxuICBfcG9seWdvbjogJyRwb2x5Z29uJyxcbiAgX2NlbnRlclNwaGVyZTogJyRjZW50ZXJTcGhlcmUnLFxuICBfZ2VvSW50ZXJzZWN0czogJyRnZW9JbnRlcnNlY3RzJyxcbiAgX3BvaW50OiAnJHBvaW50Jyxcbn07XG5cbmNvbnN0IHRyYW5zZm9ybVRvUGFyc2UgPSBjb25zdHJhaW50cyA9PiB7XG4gIGlmICghY29uc3RyYWludHMgfHwgdHlwZW9mIGNvbnN0cmFpbnRzICE9PSAnb2JqZWN0Jykge1xuICAgIHJldHVybjtcbiAgfVxuICBPYmplY3Qua2V5cyhjb25zdHJhaW50cykuZm9yRWFjaChmaWVsZE5hbWUgPT4ge1xuICAgIGxldCBmaWVsZFZhbHVlID0gY29uc3RyYWludHNbZmllbGROYW1lXTtcbiAgICBpZiAocGFyc2VNYXBbZmllbGROYW1lXSkge1xuICAgICAgZGVsZXRlIGNvbnN0cmFpbnRzW2ZpZWxkTmFtZV07XG4gICAgICBmaWVsZE5hbWUgPSBwYXJzZU1hcFtmaWVsZE5hbWVdO1xuICAgICAgY29uc3RyYWludHNbZmllbGROYW1lXSA9IGZpZWxkVmFsdWU7XG4gICAgfVxuICAgIHN3aXRjaCAoZmllbGROYW1lKSB7XG4gICAgICBjYXNlICckcG9pbnQnOlxuICAgICAgY2FzZSAnJG5lYXJTcGhlcmUnOlxuICAgICAgICBpZiAodHlwZW9mIGZpZWxkVmFsdWUgPT09ICdvYmplY3QnICYmICFmaWVsZFZhbHVlLl9fdHlwZSkge1xuICAgICAgICAgIGZpZWxkVmFsdWUuX190eXBlID0gJ0dlb1BvaW50JztcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJyRib3gnOlxuICAgICAgICBpZiAoXG4gICAgICAgICAgdHlwZW9mIGZpZWxkVmFsdWUgPT09ICdvYmplY3QnICYmXG4gICAgICAgICAgZmllbGRWYWx1ZS5ib3R0b21MZWZ0ICYmXG4gICAgICAgICAgZmllbGRWYWx1ZS51cHBlclJpZ2h0XG4gICAgICAgICkge1xuICAgICAgICAgIGZpZWxkVmFsdWUgPSBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIF9fdHlwZTogJ0dlb1BvaW50JyxcbiAgICAgICAgICAgICAgLi4uZmllbGRWYWx1ZS5ib3R0b21MZWZ0LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgX190eXBlOiAnR2VvUG9pbnQnLFxuICAgICAgICAgICAgICAuLi5maWVsZFZhbHVlLnVwcGVyUmlnaHQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF07XG4gICAgICAgICAgY29uc3RyYWludHNbZmllbGROYW1lXSA9IGZpZWxkVmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICckcG9seWdvbic6XG4gICAgICAgIGlmIChmaWVsZFZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICBmaWVsZFZhbHVlLmZvckVhY2goZ2VvUG9pbnQgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBnZW9Qb2ludCA9PT0gJ29iamVjdCcgJiYgIWdlb1BvaW50Ll9fdHlwZSkge1xuICAgICAgICAgICAgICBnZW9Qb2ludC5fX3R5cGUgPSAnR2VvUG9pbnQnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnJGNlbnRlclNwaGVyZSc6XG4gICAgICAgIGlmIChcbiAgICAgICAgICB0eXBlb2YgZmllbGRWYWx1ZSA9PT0gJ29iamVjdCcgJiZcbiAgICAgICAgICBmaWVsZFZhbHVlLmNlbnRlciAmJlxuICAgICAgICAgIGZpZWxkVmFsdWUuZGlzdGFuY2VcbiAgICAgICAgKSB7XG4gICAgICAgICAgZmllbGRWYWx1ZSA9IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgX190eXBlOiAnR2VvUG9pbnQnLFxuICAgICAgICAgICAgICAuLi5maWVsZFZhbHVlLmNlbnRlcixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmaWVsZFZhbHVlLmRpc3RhbmNlLFxuICAgICAgICAgIF07XG4gICAgICAgICAgY29uc3RyYWludHNbZmllbGROYW1lXSA9IGZpZWxkVmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgZmllbGRWYWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHRyYW5zZm9ybVRvUGFyc2UoZmllbGRWYWx1ZSk7XG4gICAgfVxuICB9KTtcbn07XG5cbmNvbnN0IGZpbmRPYmplY3RzID0gYXN5bmMgKFxuICBjbGFzc05hbWUsXG4gIHdoZXJlLFxuICBvcmRlcixcbiAgc2tpcCxcbiAgbGltaXQsXG4gIGtleXMsXG4gIGluY2x1ZGUsXG4gIGluY2x1ZGVBbGwsXG4gIHJlYWRQcmVmZXJlbmNlLFxuICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gIHN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UsXG4gIGNvbmZpZyxcbiAgYXV0aCxcbiAgaW5mbyxcbiAgc2VsZWN0ZWRGaWVsZHNcbikgPT4ge1xuICBpZiAoIXdoZXJlKSB7XG4gICAgd2hlcmUgPSB7fTtcbiAgfVxuXG4gIHRyYW5zZm9ybVRvUGFyc2Uod2hlcmUpO1xuXG4gIGNvbnN0IG9wdGlvbnMgPSB7fTtcblxuICBpZiAoc2VsZWN0ZWRGaWVsZHMuaW5jbHVkZXMoJ3Jlc3VsdHMnKSkge1xuICAgIGlmIChsaW1pdCB8fCBsaW1pdCA9PT0gMCkge1xuICAgICAgb3B0aW9ucy5saW1pdCA9IGxpbWl0O1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5saW1pdCAhPT0gMCkge1xuICAgICAgaWYgKG9yZGVyKSB7XG4gICAgICAgIG9wdGlvbnMub3JkZXIgPSBvcmRlcjtcbiAgICAgIH1cbiAgICAgIGlmIChza2lwKSB7XG4gICAgICAgIG9wdGlvbnMuc2tpcCA9IHNraXA7XG4gICAgICB9XG4gICAgICBpZiAoY29uZmlnLm1heExpbWl0ICYmIG9wdGlvbnMubGltaXQgPiBjb25maWcubWF4TGltaXQpIHtcbiAgICAgICAgLy8gU2lsZW50bHkgcmVwbGFjZSB0aGUgbGltaXQgb24gdGhlIHF1ZXJ5IHdpdGggdGhlIG1heCBjb25maWd1cmVkXG4gICAgICAgIG9wdGlvbnMubGltaXQgPSBjb25maWcubWF4TGltaXQ7XG4gICAgICB9XG4gICAgICBpZiAoa2V5cykge1xuICAgICAgICBvcHRpb25zLmtleXMgPSBrZXlzO1xuICAgICAgfVxuICAgICAgaWYgKGluY2x1ZGVBbGwgPT09IHRydWUpIHtcbiAgICAgICAgb3B0aW9ucy5pbmNsdWRlQWxsID0gaW5jbHVkZUFsbDtcbiAgICAgIH1cbiAgICAgIGlmICghb3B0aW9ucy5pbmNsdWRlQWxsICYmIGluY2x1ZGUpIHtcbiAgICAgICAgb3B0aW9ucy5pbmNsdWRlID0gaW5jbHVkZTtcbiAgICAgIH1cbiAgICAgIGlmICgob3B0aW9ucy5pbmNsdWRlQWxsIHx8IG9wdGlvbnMuaW5jbHVkZSkgJiYgaW5jbHVkZVJlYWRQcmVmZXJlbmNlKSB7XG4gICAgICAgIG9wdGlvbnMuaW5jbHVkZVJlYWRQcmVmZXJlbmNlID0gaW5jbHVkZVJlYWRQcmVmZXJlbmNlO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBvcHRpb25zLmxpbWl0ID0gMDtcbiAgfVxuXG4gIGlmIChzZWxlY3RlZEZpZWxkcy5pbmNsdWRlcygnY291bnQnKSkge1xuICAgIG9wdGlvbnMuY291bnQgPSB0cnVlO1xuICB9XG5cbiAgaWYgKHJlYWRQcmVmZXJlbmNlKSB7XG4gICAgb3B0aW9ucy5yZWFkUHJlZmVyZW5jZSA9IHJlYWRQcmVmZXJlbmNlO1xuICB9XG4gIGlmIChPYmplY3Qua2V5cyh3aGVyZSkubGVuZ3RoID4gMCAmJiBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlKSB7XG4gICAgb3B0aW9ucy5zdWJxdWVyeVJlYWRQcmVmZXJlbmNlID0gc3VicXVlcnlSZWFkUHJlZmVyZW5jZTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCByZXN0LmZpbmQoXG4gICAgY29uZmlnLFxuICAgIGF1dGgsXG4gICAgY2xhc3NOYW1lLFxuICAgIHdoZXJlLFxuICAgIG9wdGlvbnMsXG4gICAgaW5mby5jbGllbnRTREtcbiAgKTtcbn07XG5cbmNvbnN0IGxvYWQgPSBwYXJzZUdyYXBoUUxTY2hlbWEgPT4ge1xuICBwYXJzZUdyYXBoUUxTY2hlbWEuZ3JhcGhRTE9iamVjdHNRdWVyaWVzLmdldCA9IHtcbiAgICBkZXNjcmlwdGlvbjpcbiAgICAgICdUaGUgZ2V0IHF1ZXJ5IGNhbiBiZSB1c2VkIHRvIGdldCBhbiBvYmplY3Qgb2YgYSBjZXJ0YWluIGNsYXNzIGJ5IGl0cyBvYmplY3RJZC4nLFxuICAgIGFyZ3M6IHtcbiAgICAgIGNsYXNzTmFtZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5DTEFTU19OQU1FX0FUVCxcbiAgICAgIG9iamVjdElkOiBkZWZhdWx0R3JhcGhRTFR5cGVzLk9CSkVDVF9JRF9BVFQsXG4gICAgICBrZXlzOiBkZWZhdWx0R3JhcGhRTFR5cGVzLktFWVNfQVRULFxuICAgICAgaW5jbHVkZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5JTkNMVURFX0FUVCxcbiAgICAgIHJlYWRQcmVmZXJlbmNlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLlJFQURfUFJFRkVSRU5DRV9BVFQsXG4gICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2U6IGRlZmF1bHRHcmFwaFFMVHlwZXMuSU5DTFVERV9SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgIH0sXG4gICAgdHlwZTogbmV3IEdyYXBoUUxOb25OdWxsKGRlZmF1bHRHcmFwaFFMVHlwZXMuT0JKRUNUKSxcbiAgICBhc3luYyByZXNvbHZlKF9zb3VyY2UsIGFyZ3MsIGNvbnRleHQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgb2JqZWN0SWQsXG4gICAgICAgICAga2V5cyxcbiAgICAgICAgICBpbmNsdWRlLFxuICAgICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgfSA9IGFyZ3M7XG4gICAgICAgIGNvbnN0IHsgY29uZmlnLCBhdXRoLCBpbmZvIH0gPSBjb250ZXh0O1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBnZXRPYmplY3QoXG4gICAgICAgICAgY2xhc3NOYW1lLFxuICAgICAgICAgIG9iamVjdElkLFxuICAgICAgICAgIGtleXMsXG4gICAgICAgICAgaW5jbHVkZSxcbiAgICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgY29uZmlnLFxuICAgICAgICAgIGF1dGgsXG4gICAgICAgICAgaW5mb1xuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBwYXJzZUdyYXBoUUxTY2hlbWEuaGFuZGxlRXJyb3IoZSk7XG4gICAgICB9XG4gICAgfSxcbiAgfTtcblxuICBwYXJzZUdyYXBoUUxTY2hlbWEuZ3JhcGhRTE9iamVjdHNRdWVyaWVzLmZpbmQgPSB7XG4gICAgZGVzY3JpcHRpb246XG4gICAgICAnVGhlIGZpbmQgcXVlcnkgY2FuIGJlIHVzZWQgdG8gZmluZCBvYmplY3RzIG9mIGEgY2VydGFpbiBjbGFzcy4nLFxuICAgIGFyZ3M6IHtcbiAgICAgIGNsYXNzTmFtZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5DTEFTU19OQU1FX0FUVCxcbiAgICAgIHdoZXJlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLldIRVJFX0FUVCxcbiAgICAgIG9yZGVyOiB7XG4gICAgICAgIGRlc2NyaXB0aW9uOlxuICAgICAgICAgICdUaGlzIGlzIHRoZSBvcmRlciBpbiB3aGljaCB0aGUgb2JqZWN0cyBzaG91bGQgYmUgcmV0dXJuZWQnLFxuICAgICAgICB0eXBlOiBHcmFwaFFMU3RyaW5nLFxuICAgICAgfSxcbiAgICAgIHNraXA6IGRlZmF1bHRHcmFwaFFMVHlwZXMuU0tJUF9BVFQsXG4gICAgICBsaW1pdDogZGVmYXVsdEdyYXBoUUxUeXBlcy5MSU1JVF9BVFQsXG4gICAgICBrZXlzOiBkZWZhdWx0R3JhcGhRTFR5cGVzLktFWVNfQVRULFxuICAgICAgaW5jbHVkZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5JTkNMVURFX0FUVCxcbiAgICAgIGluY2x1ZGVBbGw6IHtcbiAgICAgICAgZGVzY3JpcHRpb246ICdBbGwgcG9pbnRlcnMgd2lsbCBiZSByZXR1cm5lZCcsXG4gICAgICAgIHR5cGU6IEdyYXBoUUxCb29sZWFuLFxuICAgICAgfSxcbiAgICAgIHJlYWRQcmVmZXJlbmNlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLlJFQURfUFJFRkVSRU5DRV9BVFQsXG4gICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2U6IGRlZmF1bHRHcmFwaFFMVHlwZXMuSU5DTFVERV9SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgICAgc3VicXVlcnlSZWFkUHJlZmVyZW5jZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5TVUJRVUVSWV9SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgIH0sXG4gICAgdHlwZTogbmV3IEdyYXBoUUxOb25OdWxsKGRlZmF1bHRHcmFwaFFMVHlwZXMuRklORF9SRVNVTFQpLFxuICAgIGFzeW5jIHJlc29sdmUoX3NvdXJjZSwgYXJncywgY29udGV4dCwgcXVlcnlJbmZvKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgY2xhc3NOYW1lLFxuICAgICAgICAgIHdoZXJlLFxuICAgICAgICAgIG9yZGVyLFxuICAgICAgICAgIHNraXAsXG4gICAgICAgICAgbGltaXQsXG4gICAgICAgICAga2V5cyxcbiAgICAgICAgICBpbmNsdWRlLFxuICAgICAgICAgIGluY2x1ZGVBbGwsXG4gICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgaW5jbHVkZVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIHN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UsXG4gICAgICAgIH0gPSBhcmdzO1xuICAgICAgICBjb25zdCB7IGNvbmZpZywgYXV0aCwgaW5mbyB9ID0gY29udGV4dDtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZHMgPSBnZXRGaWVsZE5hbWVzKHF1ZXJ5SW5mbyk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IGZpbmRPYmplY3RzKFxuICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICB3aGVyZSxcbiAgICAgICAgICBvcmRlcixcbiAgICAgICAgICBza2lwLFxuICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgIGtleXMsXG4gICAgICAgICAgaW5jbHVkZSxcbiAgICAgICAgICBpbmNsdWRlQWxsLFxuICAgICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBhdXRoLFxuICAgICAgICAgIGluZm8sXG4gICAgICAgICAgc2VsZWN0ZWRGaWVsZHNcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcGFyc2VHcmFwaFFMU2NoZW1hLmhhbmRsZUVycm9yKGUpO1xuICAgICAgfVxuICAgIH0sXG4gIH07XG5cbiAgY29uc3Qgb2JqZWN0c1F1ZXJ5ID0gbmV3IEdyYXBoUUxPYmplY3RUeXBlKHtcbiAgICBuYW1lOiAnT2JqZWN0c1F1ZXJ5JyxcbiAgICBkZXNjcmlwdGlvbjogJ09iamVjdHNRdWVyeSBpcyB0aGUgdG9wIGxldmVsIHR5cGUgZm9yIG9iamVjdHMgcXVlcmllcy4nLFxuICAgIGZpZWxkczogcGFyc2VHcmFwaFFMU2NoZW1hLmdyYXBoUUxPYmplY3RzUXVlcmllcyxcbiAgfSk7XG4gIHBhcnNlR3JhcGhRTFNjaGVtYS5ncmFwaFFMVHlwZXMucHVzaChvYmplY3RzUXVlcnkpO1xuXG4gIHBhcnNlR3JhcGhRTFNjaGVtYS5ncmFwaFFMUXVlcmllcy5vYmplY3RzID0ge1xuICAgIGRlc2NyaXB0aW9uOiAnVGhpcyBpcyB0aGUgdG9wIGxldmVsIGZvciBvYmplY3RzIHF1ZXJpZXMuJyxcbiAgICB0eXBlOiBvYmplY3RzUXVlcnksXG4gICAgcmVzb2x2ZTogKCkgPT4gbmV3IE9iamVjdCgpLFxuICB9O1xufTtcblxuZXhwb3J0IHsgZ2V0T2JqZWN0LCBmaW5kT2JqZWN0cywgbG9hZCB9O1xuIl19